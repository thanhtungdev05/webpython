{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5" style="max-width: 700px;">
    <div class="card shadow p-4">
        <h3 class="text-center mb-3 fw-bold">Thanh to√°n Tour #{{ booking.id }}</h3>
        <p class="text-center text-muted">
            Vui l√≤ng nh·∫≠p th√¥ng tin tr∆∞·ªõc khi thanh to√°n qua QR Code
        </p>

        <!-- FORM TH√îNG TIN -->
        <form id="customerForm">
    {% csrf_token %}
    <div class="mb-3">
        <label class="form-label">H·ªç v√† t√™n</label>
        <input type="text" id="fullName" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
        <input type="text" id="phone" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="email" class="form-control" required>
    </div>

    <!-- Th√¥ng tin b·ªï sung -->
    <div class="mb-3">
        <label class="form-label">N∆°i ·ªü hi·ªán t·∫°i</label>
        <input type="text" id="address" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Ng√†y sinh</label>
        <input type="date" id="birthDate" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">S·ªë CCCD</label>
        <input type="text" id="cccd" class="form-control" required>
    </div>

    <button type="button" onclick="showQR()" class="btn btn-primary w-100">
        X√°c nh·∫≠n th√¥ng tin
    </button>
</form>

        <!-- QR SECTION -->
        <div id="qrSection" class="text-center" style="display:none;">
            <p class="mt-3"><strong>S·ªë ti·ªÅn:</strong>
                <span id="amountText">{{ amount }}</span> ‚Ç´
            </p>

            <img id="qrImg" class="img-fluid my-3 rounded shadow"
                 style="max-width: 280px; background: white; padding: 10px; border: 2px solid #0d6efd;">

            <p class="text-muted">üí° Sau khi chuy·ªÉn kho·∫£n, vui l√≤ng b·∫•m "T√¥i ƒë√£ chuy·ªÉn kho·∫£n" ƒë·ªÉ x√°c nh·∫≠n!</p>

            <button id="paidBtn" class="btn btn-success w-50">T√¥i ƒë√£ chuy·ªÉn kho·∫£n</button>

            <div id="statusMessage" class="mt-3 text-info fw-bold" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
    // Format s·ªë ti·ªÅn VND
    function formatVND(num) {
        return Number(num).toLocaleString('vi-VN');
    }

    document.addEventListener("DOMContentLoaded", () => {
        const amountElem = document.getElementById("amountText");
        let raw = parseFloat(amountElem.textContent);
        amountElem.textContent = formatVND(raw);
    });

    // Hi·ªÉn th·ªã QR
function showQR() {
    const fullName = document.getElementById("fullName").value;
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;
    const address = document.getElementById("address").value;
    const birthDate = document.getElementById("birthDate").value;
    const cccd = document.getElementById("cccd").value;

    // Validate ƒë∆°n gi·∫£n
    if(!fullName || !phone || !email || !address || !birthDate || !cccd) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
    }

    // C·∫≠p nh·∫≠t th√¥ng tin kh√°ch v√†o server tr∆∞·ªõc khi hi·ªÉn th·ªã QR
    fetch("{% url 'update_customer_info' booking.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            full_name: fullName,
            phone: phone,
            email: email,
            address: address,
            birth_date: birthDate,
            cccd: cccd
        })
    }).then(res => res.json()).then(data => {
        if(data.success) {
            // Hi·ªÉn th·ªã QR
            document.getElementById("customerForm").style.display = "none";
            document.getElementById("qrSection").style.display = "block";

            let amount = "{{ amount }}";
            let bookingId = "{{ booking.id }}";
            let qrUrl = `https://img.vietqr.io/image/970415-1234567890-compact.png?amount=${amount}&addInfo=ThanhToanTour${bookingId}`;
            document.getElementById("qrImg").src = qrUrl;
        } else {
            alert("C·∫≠p nh·∫≠t th√¥ng tin kh√°ch th·∫•t b·∫°i!");
        }
    });
}

    // X√°c nh·∫≠n thanh to√°n
document.getElementById("paidBtn").addEventListener("click", () => {
    const statusMsg = document.getElementById("statusMessage");
    statusMsg.style.display = "block";

    let countdown = 10;
    statusMsg.textContent = `ƒêang ch·ªù x√°c nh·∫≠n (${countdown}s)...`;

    // AJAX c·∫≠p nh·∫≠t status
    fetch("{% url 'update_booking_status' booking.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({status: "ƒê√£ thanh to√°n"})
    });

    // ƒê·∫øm ng∆∞·ª£c 10s tr∆∞·ªõc khi chuy·ªÉn trang
    const interval = setInterval(() => {
        countdown--;
        statusMsg.textContent = `ƒêang ch·ªù x√°c nh·∫≠n (${countdown}s)...`;
        if (countdown <= 0) {
            clearInterval(interval);
            window.location.href = "/profile/";
        }
    }, 1000);
});
</script>

<style>
    #customerForm input:focus {
        box-shadow: 0 0 5px #0d6efd;
        border-color: #0d6efd;
    }

    #paidBtn:hover {
        transform: scale(1.05);
        transition: 0.2s;
    }

    #qrSection img {
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}