{% extends 'base.html' %} {% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'css/tour_list.css' %}" />

<div class="container mt-5">

  <!-- üîç Thanh t√¨m ki·∫øm -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="page-title">Danh s√°ch Tours</h3>
    <form class="search-form d-flex position-relative" method="get" action="{% url 'tour_list' %}">
      <input id="searchBox" class="form-control me-2" name="q" placeholder="T√¨m tour, ƒë·ªãa ƒëi·ªÉm..." value="{{ q }}" autocomplete="off"/>
      <button class="btn btn-search">T√¨m</button>
      <ul id="suggestList" class="list-group suggestions position-absolute"></ul>
    </form>
  </div>

  <!-- üîΩ B·ªô l·ªçc tour -->
  <div class="mb-3 d-flex gap-2">
    <select id="countryFilter" class="form-select" style="width: 200px;">
      <option value="">T·∫•t c·∫£ qu·ªëc gia</option>
      <option value="Trong n∆∞·ªõc">Trong n∆∞·ªõc</option>
      <option value="Ngo√†i n∆∞·ªõc">Ngo√†i n∆∞·ªõc</option>
    </select>

    <select id="durationFilter" class="form-select" style="width: 200px;">
      <option value="">T·∫•t c·∫£ s·ªë ng√†y</option>
      <option value="2">2 ng√†y</option>
      <option value="3">3 ng√†y</option>
      <option value="4">4 ng√†y</option>
      <option value="5">5 ng√†y</option>
      <option value="6">6 ng√†y</option>
      <option value="7">7 ng√†y</option>
    </select>
  </div>

  <!-- üß≠ Danh s√°ch tour -->
  <div class="row" id="tourList">
    {% for tour in tours %}
    {% comment %} L·∫•y s·ªë ng√†y t·ª´ tour.duration: "2 ng√†y 1 ƒë√™m" => "2" {% endcomment %}
    {% with tour.duration|slice:":1" as day_number %}
    <div class="col-md-4 mb-4" data-country="{{ tour.destination.country_type }}" data-days="{{ day_number }}">
      <div class="card tour-card h-100 shadow-sm">
        <div class="card-media">
          <img src="{{ tour.image_url }}" class="card-img-top" alt="{{ tour.title }}" />
        </div>
        <div class="card-body">
          <h5 class="card-title">{{ tour.title }}</h5>
          <p class="card-meta">{{ tour.destination.name }} ¬∑ {{ tour.duration }}</p>
          <p class="card-text text-truncate">{{ tour.schedule|truncatewords:18 }}</p>
          <div class="d-flex align-items-center mt-3">
            <div class="price fw-bold text-success">{{ tour.price }} VNƒê</div>
            <a href="{% url 'tour_detail' tour.id %}" class="btn btn-primary btn-sm ms-auto">Chi ti·∫øt</a>
          </div>
        </div>
      </div>
    </div>
    {% endwith %}
    {% empty %}
    <div class="col-12 text-center py-5 empty-state">
      <img src="{% static 'icons/empty-tour.png' %}" alt="empty" width="140" class="mb-3 opacity-75" />
      <h5 class="text-muted">Ch∆∞a c√≥ tour n√†o ph√π h·ª£p</h5>
      <p class="text-muted">B·∫°n c√≥ th·ªÉ xem c√°c tour n·ªïi b·∫≠t ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc.</p>
      <a href="{% url 'tour_list' %}" class="btn btn-outline-primary mt-3">Xem t·∫•t c·∫£ tour</a>
    </div>
    {% endfor %}
  </div>

  <!-- ‚ú® G·ª£i √Ω khi kh√¥ng c√≥ k·∫øt qu·∫£ -->
  {% if similar_tours %}
  <hr class="my-4" />
  <h5 class="mb-3">G·ª£i √Ω cho b·∫°n</h5>
  <div class="row">
    {% for t in similar_tours %}
    <div class="col-md-4 mb-3">
      <div class="card small-card h-100 shadow-sm">
        <img src="{{ t.image_url }}" class="card-img-top" alt="{{ t.title }}" />
        <div class="card-body">
          <h6 class="mb-1">{{ t.title }}</h6>
          <div class="text-success fw-bold">{{ t.price|floatformat:0 }} VNƒê</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

</div>

<!-- üß† Script autocomplete + filter tour -->
<script>
  // Autocomplete search
  const searchBox = document.getElementById("searchBox");
  const suggestList = document.getElementById("suggestList");

  searchBox.addEventListener("input", async () => {
    const q = searchBox.value.trim();
    suggestList.innerHTML = "";
    if (!q) return;

    const res = await fetch(`/suggest-destination/?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    data.forEach(name => {
      const li = document.createElement("li");
      li.textContent = name;
      li.className = "list-group-item list-group-item-action";
      li.addEventListener("click", () => {
        searchBox.value = name;
        suggestList.innerHTML = "";
      });
      suggestList.appendChild(li);
    });
  });

  // Filter tour theo country v√† s·ªë ng√†y
  const countryFilter = document.getElementById("countryFilter");
  const durationFilter = document.getElementById("durationFilter");
  const tourList = document.getElementById("tourList");

  function filterTours() {
    const countryValue = countryFilter.value.trim();
    const dayValue = durationFilter.value.trim();
    const tours = tourList.querySelectorAll("[data-country]");
    let anyVisible = false;

    tours.forEach(tour => {
      const country = tour.getAttribute("data-country");
      const days = tour.getAttribute("data-days");
      const show = (!countryValue || country === countryValue) &&
                   (!dayValue || days === dayValue);
      tour.style.display = show ? "block" : "none";
      if (show) anyVisible = true;
    });

    const emptyState = document.querySelector(".empty-state");
    if (emptyState) emptyState.style.display = anyVisible ? "none" : "block";
  }

  countryFilter.addEventListener("change", filterTours);
  durationFilter.addEventListener("change", filterTours);
</script>
{% endblock %}
