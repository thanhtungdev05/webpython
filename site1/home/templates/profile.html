{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">H·ªì s∆° c√° nh√¢n</h2>
  <p><strong>T√™n:</strong> {{ request.user.username }}</p>
  <p><strong>Email:</strong> {{ request.user.email }}</p>

  <div class="stats d-flex justify-content-around my-4">
    <div class="bg-primary text-white p-3 rounded text-center flex-fill mx-1">
      <h4>ƒê√£ tham gia</h4>
      <p>{{ completed_bookings }}</p>
    </div>
    <div class="bg-danger text-white p-3 rounded text-center flex-fill mx-1">
      <h4>ƒê√£ h·ªßy</h4>
      <p>{{ cancelled_bookings }}</p>
    </div>
    <div class="bg-success text-white p-3 rounded text-center flex-fill mx-1">
      <h4>T·ªïng ƒë∆°n</h4>
      <p>{{ total_bookings }}</p>
    </div>
  </div>

  <hr>
  <h4>L·ªãch s·ª≠ ƒë·∫∑t tour</h4>
  {% if bookings %}
  <table class="table table-bordered mt-3 text-center align-middle">
    <thead class="table-dark">
      <tr>
        <th>M√£ ƒë∆°n</th>
        <th>Tour</th>
        <th>Ng√†y ƒë·∫∑t</th>
        <th>S·ªë l∆∞·ª£ng</th>
        <th>T·ªïng ti·ªÅn</th>
        <th>Tr·∫°ng th√°i</th>
      </tr>
    </thead>
    <tbody>
    {% for b in bookings %}
    <tr data-booking-id="{{ b.id }}">
      <td>{{ b.id }}</td>
      <td>{{ b.tour.title }}</td>
      <td>{{ b.booking_date|date:"d/m/Y" }}</td>
      <td>
        <input type="number" class="form-control pax-input" 
               value="{{ b.pax }}" min="1" 
               style="width:80px; margin:auto;">
      </td>
      <td class="total-price">{{ b.total_price|floatformat:0 }} ‚Ç´</td>
      <td>
        {% if b.status == "Pending" %}
          <button class="btn btn-sm btn-warning approve-btn">ƒêang duy·ªát</button>
          <button class="btn btn-sm btn-danger cancel-btn">H·ªßy</button>
        {% elif b.status == "Duy·ªát" %}
          <span class="badge bg-success">ƒê√£ duy·ªát</span>
        {% elif b.status == "H·ªßy" %}
          <span class="badge bg-danger">ƒê√£ h·ªßy</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>B·∫°n ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t tour n√†o.</p>
  {% endif %}
</div>

<script>
// ‚úÖ L·∫•y token CSRF t·ª± ƒë·ªông (an to√†n h∆°n)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    headers: { 'X-CSRFToken': csrftoken }
});

$(document).ready(function(){

    // ‚úÖ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ng∆∞·ªùi
    $('.pax-input').on('change', function(){
        var row = $(this).closest('tr');
        var booking_id = row.data('booking-id');
        var pax = $(this).val();

        $.ajax({
            url: "{% url 'update_pax' %}",
            type: "POST",
            data: { 'booking_id': booking_id, 'pax': pax },
            success: function(response){
                if(response.success){
                    row.find('.total-price').text(response.total_price);
                } else {
                    alert(response.error || 'L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng!');
                }
            },
            error: function(){
                alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
            }
        });
    });

    // ‚úÖ Duy·ªát tour
    $('.approve-btn').on('click', function(){
        var row = $(this).closest('tr');
        var booking_id = row.data('booking-id');
        $.ajax({
            url: "{% url 'approve_booking_ajax' %}",
            type: "POST",
            data: { 'booking_id': booking_id },
            success: function(response){
                if(response.success){
                    row.find('td:last').html('<span class="badge bg-success">ƒê√£ duy·ªát</span>');
                }
            }
        });
    });

    $(document).ready(function(){
    $('.cancel-btn').on('click', function(){
        var row = $(this).closest('tr');
        var booking_id = row.data('booking-id');
        if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n n√†y kh√¥ng?')){
            $.ajax({
                url: "{% url 'cancel_booking_ajax' %}",
                type: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                data: { 'booking_id': booking_id },
                success: function(response){
                    console.log(response); // ki·ªÉm tra log
                    if(response.success){
                        row.fadeOut(300, function(){ $(this).remove(); });
                    } else {
                        alert("‚ùå " + (response.error || "Kh√¥ng th·ªÉ h·ªßy!"));
                    }
                },
                error: function(xhr){
                    alert("üö® L·ªói server: " + xhr.status + " " + xhr.statusText);
                }
            });
        }
    });
});
      

  });
  </script>
{% endblock %}
