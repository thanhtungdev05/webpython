{% extends 'base.html' %} {% load static %} {% block title %}Há»“ sÆ¡ cÃ¡ nhÃ¢n
{%endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}?v=2" />
{% endblock %} {% block content %}
<div class="container py-5">
  <h2 class="text-center mb-4 fw-bold">ğŸ‘¤ Há»“ sÆ¡ cÃ¡ nhÃ¢n</h2>

  <!-- ğŸ”¸ ThÃ´ng tin ngÆ°á»i dÃ¹ng -->
  <div class="card shadow-sm border-0 rounded-3 mb-4">
    <div class="card-body">
      <p><strong>TÃªn Ä‘Äƒng nháº­p:</strong> {{ user.username }}</p>
      <p><strong>Email:</strong> {{ user.email }}</p>
    </div>
  </div>

  <hr class="my-4" />

  <h4 class="fw-semibold mb-3">â¤ï¸Tour YÃªu ThÃ­ch</h4>
  {% if favorites %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for f in favorites %}
    <div class="col">
      <div class="card h-100 shadow-sm border-0 rounded-3">
        {% if f.tour.image %}
        <img
          src="{{ f.tour.image.url }}"
          class="card-img-top"
          alt="{{ f.tour.title }}"
        />
        {% endif %}
        <div class="card-body">
          <h5 class="card-title text-primary">{{ f.tour.title }}</h5>
          <p class="card-text">{{ f.tour.description|truncatewords:20 }}</p>
          <a
            href="{% url 'tour_detail' f.tour.id %}"
            class="btn btn-outline-primary btn-sm"
          >
            <i class="bi bi-eye"></i> Xem chi tiáº¿t
          </a>
          <a
            href="{% url 'remove_favorite' f.tour.id %}"
            class="btn btn-outline-danger btn-sm"
          >
            <i class="bi bi-x-circle"></i> XÃ³a
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info text-center mt-3">
    Báº¡n chÆ°a thÃªm tour nÃ o vÃ o yÃªu thÃ­ch ğŸ’”
  </div>
  {% endif %}
  <h4 class="fw-semibold mb-3">ğŸ§³ Lá»‹ch sá»­ Ä‘áº·t tour</h4>
  {% if bookings %}
  <div class="table-responsive">
    <table
      class="table table-bordered table-hover text-center align-middle shadow-sm"
    >
      <thead class="table-dark">
        <tr>
          <th>MÃ£ Ä‘Æ¡n</th>
          <th>Tour</th>
          <th>NgÃ y Ä‘áº·t</th>
          <th>Sá»‘ lÆ°á»£ng</th>
          <th>Tá»•ng tiá»n (VNÄ)</th>
          <th>Tráº¡ng thÃ¡i</th>
          <th style="width: 180px">Thao tÃ¡c</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bookings %}
        <tr data-booking-id="{{ b.id }}">
          <td>{{ b.id }}</td>
          <td class="text-start ps-3">{{ b.tour.title }}</td>
          <td>{{ b.booking_date|date:"d/m/Y" }}</td>
          <td>{{ b.pax }}</td>
          <td class="fw-bold text-primary">
            {{ b.total_price|floatformat:0 }}
          </td>
          <td>
            {% if b.status == "Pending" %}
            <span class="badge bg-warning text-dark">Äang duyá»‡t</span>
            {% elif b.status == "Duyá»‡t" %}
            <span class="badge bg-success">ÄÃ£ duyá»‡t</span>
            {% elif b.status == "ÄÃ£ thanh toÃ¡n" %}
            <span class="badge bg-info text-dark">ÄÃ£ thanh toÃ¡n</span>
            {% elif b.status == "Há»§y" %}
            <span class="badge bg-danger">ÄÃ£ há»§y</span>
            {% endif %}
          </td>
          <td>
            <div class="d-flex flex-wrap justify-content-center gap-1">
              {% if b.status == "Pending" %}
              <button class="btn btn-outline-danger btn-sm cancel-booking-btn">
                <i class="bi bi-x-circle"></i> Há»§y
              </button>
              {% elif b.status == "Duyá»‡t" %}
              <a
                href="{% url 'payment_qr' b.id %}?amount={{ b.total_price }}"
                class="btn btn-outline-primary btn-sm"
              >
                <i class="bi bi-qr-code"></i> QR
              </a>
              <button class="btn btn-outline-success btn-sm pay-cash-btn">
                <i class="bi bi-cash-coin"></i> Tiá»n máº·t
              </button>
              {% elif b.status == "ÄÃ£ thanh toÃ¡n" %}
              <button class="btn btn-outline-warning btn-sm rate-btn">
                <i class="bi bi-star"></i> ÄÃ¡nh giÃ¡
              </button>
              {% else %}
              <small class="text-muted"></small>
              {% endif %}
              <button class="btn btn-outline-info btn-sm detail-btn">
                <i class="bi bi-eye"></i> Chi tiáº¿t
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ğŸ§¾ NÃºt xuáº¥t PDF (chá»‰ hiá»‡n 1 láº§n) -->
  <div class="text-end mt-3">
    <button id="export-pdf" class="btn btn-danger">
      <i class="bi bi-file-earmark-pdf"></i> Xuáº¥t PDF
    </button>
  </div>

  {% else %}
  <div class="alert alert-info text-center mt-3">
    Báº¡n chÆ°a cÃ³ Ä‘Æ¡n Ä‘áº·t tour nÃ o.
  </div>
  {% endif %}
</div>
{% endblock %} {% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  $(function () {
    // ğŸ’° Thanh toÃ¡n tiá»n máº·t
    $(".pay-cash-btn").click(function () {
      const bookingId = $(this).closest("tr").data("booking-id");
      Swal.fire({
        title: "XÃ¡c nháº­n thanh toÃ¡n?",
        text: "Báº¡n cÃ³ cháº¯c muá»‘n thanh toÃ¡n tiá»n máº·t cho tour nÃ y?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#198754",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "XÃ¡c nháº­n",
        cancelButtonText: "Há»§y",
      }).then((result) => {
        if (result.isConfirmed) {
          $.post("{% url 'pay_cash' %}", {
            booking_id: bookingId,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          })
            .done((res) => {
              if (res.success) {
                Swal.fire(
                  "ThÃ nh cÃ´ng!",
                  "Thanh toÃ¡n thÃ nh cÃ´ng âœ…",
                  "success"
                ).then(() => location.reload());
              } else {
                Swal.fire("Lá»—i!", res.error, "error");
              }
            })
            .fail(() =>
              Swal.fire("Lá»—i há»‡ thá»‘ng!", "Vui lÃ²ng thá»­ láº¡i sau!", "error")
            );
        }
      });
    });
    // ğŸ’µ Äá»‹nh dáº¡ng láº¡i cá»™t "Tá»•ng tiá»n (VNÄ)" cho dá»… Ä‘á»c
    $(".table tbody tr").each(function () {
      const moneyCell = $(this).find("td:eq(4)"); // Cá»™t thá»© 5 lÃ  Tá»•ng tiá»n
      const rawValue = moneyCell.text().trim();

      if (!isNaN(rawValue) && rawValue !== "") {
        const formatted = Number(rawValue).toLocaleString("vi-VN"); // ThÃªm dáº¥u pháº©y
        moneyCell.text(`${formatted} VNÄ`);
      }
    });
    // âŒ Há»§y tour
    $(".cancel-booking-btn").click(function () {
      const bookingId = $(this).closest("tr").data("booking-id");
      Swal.fire({
        title: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n há»§y tour?",
        text: "HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Há»§y tour",
        cancelButtonText: "Quay láº¡i",
      }).then((result) => {
        if (result.isConfirmed) {
          $.post("{% url 'cancel_booking_ajax' %}", {
            booking_id: bookingId,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          }).done((res) => {
            if (res.success) {
              Swal.fire("ÄÃ£ há»§y!", "Tour cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c há»§y.", "success").then(
                () => location.reload()
              );
            } else {
              Swal.fire("Lá»—i!", res.error, "error");
            }
          });
        }
      });
    });

    // ğŸ‘ Chi tiáº¿t tour
    $(".detail-btn").click(function () {
      const tr = $(this).closest("tr");
      Swal.fire({
        title: "Chi tiáº¿t tour",
        html: `
        <div class="text-start">
          <p><b>TÃªn tour:</b> ${tr.find("td:eq(1)").text()}</p>
          <p><b>NgÃ y Ä‘áº·t:</b> ${tr.find("td:eq(2)").text()}</p>
          <p><b>Tá»•ng tiá»n:</b> ${tr.find("td:eq(4)").text()}</p>
          <p><b>Tráº¡ng thÃ¡i:</b> ${tr.find("td:eq(5)").text()}</p>
        </div>
      `,
        icon: "info",
        confirmButtonText: "ÄÃ³ng",
      });
    });

    // ğŸŒŸ ÄÃ¡nh giÃ¡ tour
    $(".rate-btn").click(function () {
      Swal.fire({
        title: "ÄÃ¡nh giÃ¡ tour ğŸŒŸ",
        html: `
        <div id="rating-stars" style="font-size:24px; color:#FFD700; cursor:pointer;">â˜…â˜…â˜…â˜…â˜…</div>
        <textarea id="comment" class="form-control mt-3" placeholder="Nháº­p nháº­n xÃ©t cá»§a báº¡n..."></textarea>
      `,
        showCancelButton: true,
        confirmButtonText: "Gá»­i",
        cancelButtonText: "Há»§y",
        didOpen: () => {
          const stars = $("#rating-stars");
          let rating = 5;
          stars.on("mousemove click", function (e) {
            const x = e.pageX - stars.offset().left;
            rating = Math.ceil(x / (stars.width() / 5));
            stars.text("â˜…â˜…â˜…â˜…â˜…".slice(0, rating) + "â˜†â˜†â˜†â˜†â˜†".slice(rating));
          });
        },
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire("Cáº£m Æ¡n!", "ÄÃ¡nh giÃ¡ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i ğŸ‰", "success");
        }
      });
    });

    // ğŸ§¾ Xuáº¥t PDF (chá»‰ 1 láº§n)
    $("#export-pdf").click(function () {
      Swal.fire({
        icon: "success",
        title: "Äang táº¡o file PDF...",
        text: "Vui lÃ²ng chá» trong giÃ¢y lÃ¡t â³",
        timer: 2000,
        showConfirmButton: false,
      });
    });
  });
  window.addEventListener("scroll", function () {
    const navbar = document.querySelector(".custom-navbar");
    if (window.scrollY > 50) {
      navbar.classList.add("scrolled");
    } else {
      navbar.classList.remove("scrolled");
    }
  });
</script>
{% endblock %}
